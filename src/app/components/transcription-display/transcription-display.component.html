<!-- T082-T086, T102-T105: Transcription Display Template with Virtual Scrolling -->

<!-- T104: Conditional rendering - use virtual scroll for >100 messages -->
@if (useVirtualScroll()) {
  <!-- T102: Virtual scrolling for performance with large message lists -->
  <cdk-virtual-scroll-viewport
    class="transcription-scroll-container virtual-scroll"
    [itemSize]="itemSize"
    role="log"
    aria-live="polite"
    aria-label="Voice chat transcription messages"
  >
    <div class="transcription-list">
      @if (transcriptions().length === 0 && !interimTranscription()) {
        <!-- Empty state when no transcriptions -->
        <div class="empty-state">
          <p class="hint">Transcription messages will appear here during your conversation.</p>
        </div>
      } @else {
        <!-- T102: Virtual scroll with @for loop -->
        @for (message of transcriptions(); track trackByMessageId($index, message)) {
          <div
            class="transcription-message"
            [attr.data-speaker]="message.speaker"
          >
            <div class="message-header">
              <span class="speaker-label">
                {{ message.speaker === 'user' ? 'You' : 'Agent' }}
              </span>
              <span class="timestamp">
                {{ message.timestamp | date: 'short' }}
              </span>
            </div>
            <div class="message-text">
              {{ message.text }}
            </div>
            @if (message.confidence !== undefined && message.confidence < 0.8) {
              <div class="confidence-indicator" [attr.data-confidence]="message.confidence">
                <span class="confidence-label">Low confidence</span>
              </div>
            }
          </div>
        }

        <!-- Interim (streaming) transcription -->
        @if (interimTranscription(); as interim) {
          <div
            class="transcription-message interim-message"
            [attr.data-speaker]="interim.speaker"
          >
            <div class="message-header">
              <span class="speaker-label">
                {{ interim.speaker === 'user' ? 'You' : 'Agent' }}
              </span>
              <span class="timestamp">
                {{ interim.timestamp | date: 'short' }}
              </span>
              <span class="streaming-indicator">●</span>
            </div>
            <div class="message-text streaming-text">
              {{ interim.text }}
            </div>
          </div>
        }
      }
    </div>
  </cdk-virtual-scroll-viewport>
} @else {
  <!-- Regular scrolling for smaller message lists -->
  <div class="transcription-scroll-container" #scrollContainer>
    <!-- T083: ARIA live region for accessibility -->
    <div
      class="transcription-list"
      role="log"
      aria-live="polite"
      aria-label="Voice chat transcription messages"
    >
      @if (transcriptions().length === 0 && !interimTranscription()) {
        <!-- Empty state when no transcriptions -->
        <div class="empty-state">
          <p class="hint">Transcription messages will appear here during your conversation.</p>
        </div>
      } @else {
        <!-- T082: @for loop with trackBy using message.id -->
        @for (message of transcriptions(); track trackByMessageId($index, message)) {
          <div
            class="transcription-message"
            [attr.data-speaker]="message.speaker"
          >
            <div class="message-header">
              <span class="speaker-label">
                {{ message.speaker === 'user' ? 'You' : 'Agent' }}
              </span>
              <!-- T086: Timestamp display with Angular date pipe -->
              <span class="timestamp">
                {{ message.timestamp | date: 'short' }}
              </span>
            </div>
            <div class="message-text">
              {{ message.text }}
            </div>
            @if (message.confidence !== undefined && message.confidence < 0.8) {
              <div class="confidence-indicator" [attr.data-confidence]="message.confidence">
                <span class="confidence-label">Low confidence</span>
              </div>
            }
          </div>
        }

        <!-- Interim (streaming) transcription -->
        @if (interimTranscription(); as interim) {
          <div
            class="transcription-message interim-message"
            [attr.data-speaker]="interim.speaker"
          >
            <div class="message-header">
              <span class="speaker-label">
                {{ interim.speaker === 'user' ? 'You' : 'Agent' }}
              </span>
              <span class="timestamp">
                {{ interim.timestamp | date: 'short' }}
              </span>
              <span class="streaming-indicator">●</span>
            </div>
            <div class="message-text streaming-text">
              {{ interim.text }}
            </div>
          </div>
        }
      }
    </div>
  </div>
}
